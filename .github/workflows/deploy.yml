name: Deploy to FPGA via Raspberry Pi

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'piApp/encrypted.txt'
      - 'piApp/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Verify encrypted file exists
        run: |
          if [ ! -f piApp/encrypted.txt ]; then
            echo "ERROR: encrypted.txt not found!"
            exit 1
          fi
          echo "✓ encrypted.txt found"
      
      - name: Build and send to FPGA
        run: |
          cd piApp
          g++ -o fpga_sender main.cpp
          
          # Find available serial port
          if [ -e /dev/ttyUSB0 ]; then
            PORT=/dev/ttyUSB0
          elif [ -e /dev/ttyACM0 ]; then
            PORT=/dev/ttyACM0
          else
            echo "Available serial ports:"
            ls /dev/tty* | grep -E "(USB|ACM)" || echo "No USB/ACM ports found"
            echo "Running in test mode..."
            ./fpga_sender --test --file encrypted.txt
            exit 0
          fi
          
          echo "Using serial port: $PORT"
          ./fpga_sender --file encrypted.txt --port $PORT
      
      - name: Deployment complete
        if: github.event_name == 'push'
        run: |
          echo "✓ Encrypted data sent to FPGA via Raspberry Pi!"
